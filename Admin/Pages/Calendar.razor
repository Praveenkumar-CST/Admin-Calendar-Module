@page "/calendar"
@using System.Text.Json
@using CalendarApp.Models  
@inject NavigationManager NavigationManager
@inject HttpClient Http

<div class="page-container">
    <div class="calendar-container">
        @if (isLoading)
        {
            <div class="loading-overlay">
                <div class="loading-spinner"></div>
            </div>
        }
        <div class="calendar-header-container">
            <button class="nav-button" @onclick="PreviousMonth">Previous</button>
            <h3 class="calendar-title">@currentDate.ToString("MMMM yyyy")</h3>
            <button class="nav-button" @onclick="NextMonth">Next</button>
        </div>
        <div class="calendar">
            <div class="calendar-header">
                @foreach (var day in daysOfWeek)
                {
                    <div class="day-header">@day</div>
                }
            </div>
            <div class="calendar-body">
                @foreach (var week in calendarWeeks)
                {
                    <div class="week">
                        @foreach (var day in week)
                        {
                            <div class="day @(day.IsCurrentMonth ? "" : "other-month") @(day.IsToday ? "today" : "") @(HasEvent(day.Date) ? "has-event" : "")"
                                 @onclick="() => SelectDate(day.Date)">
                                <div class="day-number">@day.Date.Day</div>
                                @if (IsHoliday(day.Date))
                                {
                                    <div class="holiday-indicator @(GetHolidayType(day.Date) == "Permanent" ? "permanent" : "optional")"></div>
                                }
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
        <div class="holidays-box" @onclick="NavigateToHolidays"><span>Holidays</span></div>
    </div>
    @if (showEventInput)
    {
        <div class="event-panel">
            <div class="event-panel-header">
                <h4>Events for @selectedDate.ToString("dddd, MMMM d, yyyy")</h4>
                <button class="close-button" @onclick="CloseEventInput">×</button>
            </div>
            <div class="event-panel-content">
                @if (hasExistingEvent)
                {
                    <div class="existing-event">
                        <strong>Event:</strong> @events[selectedDate].Description
                    </div>
                }
                @if (!string.IsNullOrEmpty(successMessage))
                {
                    <div class="success-message">@successMessage</div>
                }
                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="error-message">@errorMessage</div>
                }
                <textarea @bind="eventText" placeholder="Enter new event details..." class="event-textarea"></textarea>
                <div class="holiday-type-selection">
                    <label>Holiday Type (required):</label>
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" 
                                   @bind="isPermanentHoliday" 
                                   @onclick="() => ToggleHolidayType(true)" />
                            <span>Permanent Holiday</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" 
                                   @bind="isOptionalHoliday" 
                                   @onclick="() => ToggleHolidayType(false)" />
                            <span>Optional Holiday</span>
                        </label>
                    </div>
                </div>
                <div class="event-buttons">
                    @if (hasExistingEvent)
                    {
                        <button class="action-button save" @onclick="UpdateEvent">Update</button>
                    }
                    else
                    {
                        <button class="action-button save" @onclick="SaveEvent">Save</button>
                    }
                    <button class="action-button cancel" @onclick="CloseEventInput">Cancel</button>
                    @if (hasExistingEvent)
                    {
                        <button class="action-button delete" @onclick="DeleteEvent">Delete</button>
                    }
                </div>
            </div>
        </div>
    }
</div>

@code {
    private DateTime currentDate = DateTime.Today;
    private string[] daysOfWeek = { "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat" };
    private List<List<CalendarDay>> calendarWeeks = new();
    private Dictionary<DateTime, Event> events = new();
    private bool showEventInput;
    private DateTime selectedDate;
    private string eventText = "";
    private bool hasExistingEvent;
    private bool isPermanentHoliday = false;
    private bool isOptionalHoliday = false;
    private string? successMessage;
    private string? errorMessage;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadEvents();
        GenerateCalendar();
        isLoading = false;
    }

    private async Task LoadEvents()
    {
        // Attempts to fetch events from the API
        try
        {
            var response = await Http.GetFromJsonAsync<List<Event>>("http://localhost:5085/api/Events");
            if (response != null)
            {
                events = response
                    .Where(e => DateTime.TryParse(e.Date, out _))
                    .ToDictionary(
                        e => DateTime.Parse(e.Date!),
                        e => e
                    );
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load events: {ex.Message}";
            StateHasChanged();
            await Task.Delay(3000);
            errorMessage = null;
        }
    }

    // Calendar Generation
    private void GenerateCalendar()
    {
        // Generates the calendar view for the current month
        calendarWeeks.Clear();
        var firstOfMonth = new DateTime(currentDate.Year, currentDate.Month, 1);
        var firstDayOfWeek = (int)firstOfMonth.DayOfWeek;
        var currentDay = firstOfMonth.AddDays(-firstDayOfWeek);

        for (int week = 0; week < 6; week++)
        {
            calendarWeeks.Add(Enumerable.Range(0, 7).Select(d => new CalendarDay
            {
                Date = currentDay.AddDays(d),
                IsCurrentMonth = currentDay.AddDays(d).Month == currentDate.Month,
                IsToday = currentDay.AddDays(d).Date == DateTime.Today.Date
            }).ToList());
            currentDay = currentDay.AddDays(7);
        }
    }

    // Event Handling
    private void SelectDate(DateTime date)
    {
        // Handles date selection and shows event input panel
        selectedDate = date;
        hasExistingEvent = events.ContainsKey(date);

        if (hasExistingEvent)
        {
            eventText = events[date].Description ?? "";
            isPermanentHoliday = events[date].HolidayType == "Permanent";
            isOptionalHoliday = events[date].HolidayType == "Optional";
        }
        else
        {
            eventText = "";
            isPermanentHoliday = false;
            isOptionalHoliday = false;
        }

        showEventInput = true;
        successMessage = null;
        errorMessage = null;
        StateHasChanged();
    }

    private async Task SaveEvent()
    {
        // Validates and saves a new event
        if (string.IsNullOrWhiteSpace(eventText))
        {
            errorMessage = "Please enter event details!";
            StateHasChanged();
            await Task.Delay(3000);
            errorMessage = null;
            return;
        }

        if (!isPermanentHoliday && !isOptionalHoliday)
        {
            errorMessage = "Please select a holiday type (Permanent or Optional)!";
            StateHasChanged();
            await Task.Delay(3000);
            errorMessage = null;
            return;
        }

        try
        {
            var eventToSave = new Event
            {
                Date = selectedDate.ToString("yyyy-MM-dd"),
                Description = eventText,
                HolidayType = isPermanentHoliday ? "Permanent" : "Optional"
            };

            HttpResponseMessage response = await Http.PostAsJsonAsync("http://localhost:5085/api/Events", eventToSave);

            if (response.IsSuccessStatusCode)
            {
                await LoadEvents();
                GenerateCalendar();
                successMessage = "Event saved successfully!";
                hasExistingEvent = true;
                StateHasChanged();

                await Task.Delay(3000);
                successMessage = null;
            }
            else
            {
                errorMessage = $"Failed to save event: {await response.Content.ReadAsStringAsync()}";
                StateHasChanged();
                await Task.Delay(3000);
                errorMessage = null;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error saving event: {ex.Message}";
            StateHasChanged();
            await Task.Delay(3000);
            errorMessage = null;
        }
    }

    private async Task UpdateEvent()
    {
        // Validates and updates an existing event
        if (string.IsNullOrWhiteSpace(eventText))
        {
            errorMessage = "Please enter event details!";
            StateHasChanged();
            await Task.Delay(3000);
            errorMessage = null;
            return;
        }

        if (!isPermanentHoliday && !isOptionalHoliday)
        {
            errorMessage = "Please select a holiday type (Permanent or Optional)!";
            StateHasChanged();
            await Task.Delay(3000);
            errorMessage = null;
            return;
        }

        try
        {
            var eventToSave = new Event
            {
                Date = selectedDate.ToString("yyyy-MM-dd"),
                Description = eventText,
                HolidayType = isPermanentHoliday ? "Permanent" : "Optional"
            };

            HttpResponseMessage response = await Http.PutAsJsonAsync($"http://localhost:5085/api/Events/{selectedDate:yyyy-MM-dd}", eventToSave);

            if (response.IsSuccessStatusCode)
            {
                await LoadEvents();
                GenerateCalendar();
                successMessage = "Event updated successfully!";
                StateHasChanged();

                await Task.Delay(3000);
                successMessage = null;
            }
            else
            {
                errorMessage = $"Failed to update event: {await response.Content.ReadAsStringAsync()}";
                StateHasChanged();
                await Task.Delay(3000);
                errorMessage = null;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error updating event: {ex.Message}";
            StateHasChanged();
            await Task.Delay(3000);
            errorMessage = null;
        }
    }

    private void CloseEventInput()
    {
        // Closes the event input panel and resets fields
        showEventInput = false;
        eventText = "";
        isPermanentHoliday = false;
        isOptionalHoliday = false;
        successMessage = null;
        errorMessage = null;
        hasExistingEvent = false;
        StateHasChanged();
    }

    private async Task DeleteEvent()
    {
        // Deletes an existing event
        try
        {
            var response = await Http.DeleteAsync($"http://localhost:5085/api/Events/{selectedDate:yyyy-MM-dd}");

            if (response.IsSuccessStatusCode)
            {
                await LoadEvents();
                GenerateCalendar();
                successMessage = "Event deleted successfully!";
                hasExistingEvent = false;
                eventText = "";
                isPermanentHoliday = false;
                isOptionalHoliday = false;
                StateHasChanged();

                await Task.Delay(3000);
                successMessage = null;
            }
            else
            {
                errorMessage = $"Failed to delete event: {await response.Content.ReadAsStringAsync()}";
                StateHasChanged();
                await Task.Delay(3000);
                errorMessage = null;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error deleting event: {ex.Message}";
            StateHasChanged();
            await Task.Delay(3000);
            errorMessage = null;
        }
    }

    private void ToggleHolidayType(bool isPermanent)
    {
        // Toggles between permanent and optional holiday types
        if (isPermanent)
        {
            isPermanentHoliday = true;
            isOptionalHoliday = false;
        }
        else
        {
            isPermanentHoliday = false;
            isOptionalHoliday = true;
        }
        StateHasChanged();
    }

    private bool HasEvent(DateTime date) => events.ContainsKey(date);
    private bool IsHoliday(DateTime date) => events.ContainsKey(date);
    private string GetHolidayType(DateTime date) => events.TryGetValue(date, out var evt) ? evt.HolidayType ?? "" : "";

    // Navigation
    private void NextMonth()
    {
        currentDate = currentDate.AddMonths(1);
        GenerateCalendar();
        StateHasChanged();
    }

    private void PreviousMonth()
    {
        currentDate = currentDate.AddMonths(-1);
        GenerateCalendar();
        StateHasChanged();
    }

    private void NavigateToHolidays() => NavigationManager.NavigateTo("/holidays");
}